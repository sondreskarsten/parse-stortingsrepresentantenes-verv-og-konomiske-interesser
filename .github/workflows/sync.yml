name: Stortinget Register Sync

on:
  schedule:
    - cron: '0 6 * * 5'
  workflow_dispatch:
    inputs:
      start_year:
        description: 'Start year for scanning'
        type: number
        default: 2021
      end_year:
        description: 'End year for scanning (empty = current year)'
        type: number
        required: false

concurrency:
  group: stortinget-sync
  cancel-in-progress: false

permissions:
  contents: read
  id-token: write

env:
  STORAGE_PATH: gs://${{ vars.GCS_BUCKET }}/data

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.GCP_WIF_PROVIDER }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}

      - name: Install
        run: uv sync --frozen --extra gcs

      - name: Sync
        run: |
          uv run stortinget-register sync ${{ env.STORAGE_PATH }} \
            --start-year ${{ inputs.start_year || '2021' }} \
            ${{ inputs.end_year && format('--end-year {0}', inputs.end_year) || '' }} \
            --max-runtime 25 \
            --log-level INFO
